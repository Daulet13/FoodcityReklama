<!-- 3881a981-9b00-4696-8f55-3c3286638f20 12795fa5-c69e-4b69-925c-536f6fa9d6b7 -->
# План разработки системы учета рекламы

**Цель:** Создать простое веб-приложение на Python (Flask) и SQLite, которое заменит Excel-таблицы для учета рекламы. План сфокусирован на поэтапной разработке, чтобы минимизировать ошибки.

## Этап 1: Подготовка и фундамент _(завершено)_

1.  **Настройка окружения:**
    - Проверка и установка Python.
    - Создание структуры папок проекта.
    - Настройка виртуального окружения для изоляции зависимостей.
    - Установка базовых библиотек (Flask, Flask-SQLAlchemy) и создание файла `requirements.txt`.

2.  **Создание базового приложения:**
    - Создание основного файла `app.py`.
    - Настройка простого "Hello, World!" для проверки, что Flask работает.

## Этап 2: База данных и первые модели _(завершено)_

1.  **Настройка базы данных:**
    - Конфигурация приложения для работы с SQLite.
    - Создание моделей данных в Python-коде для "Справочников" из ТЗ: `User`, `Counterparty`, `PropertyObject`.

2.  **Инициализация БД:**
    - Создание файла базы данных и таблиц на основе определенных моделей.

## Этап 3: Первые веб-страницы (CRUD для справочников) _(в работе)_

1.  **Реализация интерфейса для "Контрагентов":**
    - Создание HTML-шаблонов для списка контрагентов и формы добавления.
    - Логика отображения и добавления записей уже реализована; редактирование и удаление запланированы.

2.  **Реализация для других справочников:**
    - Выполнены списки/создание для "Объектов".
    - В ближайших доработках: единые формы редактирования/удаления, защита от удаления с зависимостями.

## Этап 4: Основная бизнес-логика _(завершено)_

*   ✅ Создание договоров, спецификаций и добавление услуг к спецификациям.
*   ✅ Автоматическое формирование ежемесячных реализаций по спецификациям.
*   ✅ Создание разовых реализаций через модальное окно.
*   ✅ Редактирование и удаление всех сущностей (контрагенты, объекты, договоры, спецификации, реализации).

## Этап 5: Система учета оплат _(в работе)_

**Принятые решения:**
*   Вариант: Гибкая ручная привязка платежей к реализациям
*   Платеж может закрыть одну или несколько реализаций
*   Нераспределенный остаток → аванс контрагента
*   Аванс может быть зачтен при следующем платеже
*   Статус оплаты реализаций обновляется автоматически

**Детальный план:** См. `docs/PAYMENT_SYSTEM_PLAN.md`

**Задачи:**
*   [ ] Создать модель `Payment` и таблицу связи `payment_realization_association`
*   [ ] Добавить поле `paid_amount` в модель `Realization`
*   [ ] Создать страницу `/payments` с формой и списком
*   [ ] Реализовать распределение платежей на реализации
*   [ ] Реализовать механизм зачета аванса
*   [ ] Обновить визуализацию статусов оплаты в таблицах

## Этап 6: Отчеты и дашборд _(запланировано)_

*   Отчет "Дебиторская задолженность"
*   Дашборд с ключевыми показателями (прибыль по месяцам, долги, работа менеджеров).

## UI/UX Guidelines (проектные правила)

- В таблицах первая колонка (номер, название) всегда ведет на карточку сущности.
- Для каждой строки есть колонка `Действия` с кнопками `Изменить` и `Удалить` (модальные формы и подтверждения).
- На карточках сущностей дублируем `Изменить`/`Удалить` в верхней части для быстрых действий.
- Используем единый Bootstrap-стиль: компактные кнопки, подтверждения на удаление, валидация форм.

### Модальные окна редактирования и удаления

- **Вызываются** из столбца `Действия` и из карточки сущности; фокус перемещается на заголовок модалки.
- **Редактирование:** одна форма, предзаполненная существующими значениями; обязательные поля помечены, ошибки подсвечиваем под полем; кнопки `Сохранить` и `Отмена`.
- **Удаление:** компактное подтверждение с названием сущности, предупреждением о последствиях и кнопками `Удалить` (primary-danger) / `Отмена`.
- **Валидация:** повторяем правила создания (например, уникальные номера, формат дат, суммы > 0); блокируем отправку, если есть ошибки.
- **Зависимости:** перед удалением показываем список или краткое сообщение о блокирующих связях (например, "Есть спецификации/реализации"), кнопка удаления неактивна.
- **Состояние загрузки:** на отправке дизейблим кнопки, отображаем спиннер/текст `Сохранение...`.
- **Уведомления:** после успешного действия показываем `flash`-сообщение и обновляем таблицу без перезагрузки страницы (в дальнейшем через partial reload).

### Текущий фокус: Этап 5 - Система оплат

**Детальный план:** См. `docs/PAYMENT_SYSTEM_PLAN.md`

### Пройденные этапы

- [x] Настроить окружение проекта и зависимости.
- [x] Создать базовое приложение Flask и проверить запуск.
- [x] Настроить подключение к SQLite и описать ключевые модели.
- [x] Реализовать базовые страницы для справочников (контрагенты, объекты) с добавлением записей.
- [x] Настроить работу с договорами, спецификациями и автоматическим созданием реализаций.
- [x] Добавить редактирование и удаление для справочников, договоров и спецификаций.
- [x] Унифицировать дизайн всех страниц (современный минималистичный стиль).
- [x] Реорганизовать систему реализаций (удален payment_type, добавлена частичная редактируемость).
